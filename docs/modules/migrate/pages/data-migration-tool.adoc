= Using the Data Migration Tool
:description: You can use the Data Migration Tool (DMT) to migrate your data from version 4.x or 5.x Open Source and Enterprise Edition Hazelcast clusters when upgrading to 5.3.x or later versions of Enterprise Edition, or moving to the latest {hazelcast-cloud} release. The DMT can also be used for infrastructure consolidation or separation with selective migration of application data between clusters.

{description} 

NOTE: The DMT migrates your data for maps and replicated maps only. It does not migrate replicated map metadata.

DMT Use Cases:

* Migrating from an Open Source cluster to an Enterprise Edition cluster
* Migrating from an earlier version of Enterprise Edition to a newer version. Such a migration can move directly between specified versions, even if several minor versions exist between them
* Migrating from an on-premise cluster to a self-managed Enterprise Edition cluster in the cloud
* Migrating from an on-premise cluster to a {hazelcast-cloud} cluster
* Migrating specific application data from one cluster to another due to infrastructure changes

[NOTE] 
====
. You cannot use the DMT to upgrade or migrate from IMDG 3.12.x. If you are upgrading from IMDG 3.12.x, see the xref:upgrading-from-imdg-3.adoc[Upgrading from IMDG 3.12.x] topic. If migrating from IMDG 3.12.x, see the xref:migration-tool-imdg.adoc[Migrating Data from IMDG 3.12.x] topic. 

. If you want to avoid downtime, use an in-place rolling upgrade instead of the DMT tool. For further information on upgrading without interrupting the operation of the cluster, see the xref:maintain-cluster:rolling-upgrade.adoc[Rolling Upgrades] topic.
====

The DMT uses a temporary cluster called a migration cluster to transfer data from a source cluster to a new target cluster. The migration cluster uses a stream processing pipeline to efficiently transfer the data.

image::ROOT:dmt_diagram.png[DMT Clusters]

The DMT can be run on Mac, Linux, and Windows Operating Systems.

To use the DMT:

* The source cluster must be running and populated with required data
* The application must be using the source cluster
* The target cluster must be set up, but have no data

At a high-level, the migration process is as follows:

. Set up the migration cluster
. Shutdown all applications using the source cluster
. Run the migration using the DMT command
. Verify that migration was successful
. Update client applications to connect to the target cluster
. Restart the client applications

== Get the DMT

You can download the DMT https://repository.hazelcast.com/data-migration/com/hazelcast/hazelcast-enterprise-distribution/5.3.5-DM-1/[here^]. Make sure to download the correct build for your operating system and CPU type.

Once downloaded, extract the DMT package to a location in your folder structure. The DMT package includes the following:

* The DMT
* A custom Hazelcast distribution that creates a migration cluster and runs the data migration service
* Example configuration files
* Example connection configuration file, which is used to connect to the migration client


=== Limited Migration Cluster License

A 10-node limited license is included for use with your migration cluster. 

This license is valid for 30 days and can be used only for data migration and trial purposes. 

The license terms are available in the _enterprise-license.txt_ file located in the _licenses_ folder of the extracted DMT package.

== Configure the Migration Cluster

The migration cluster acts as a client to both the source and target clusters. You need to set up the client configurations for both connections. Without both configurations, the migration cluster cannot connect, and migration will fail.

=== Configuration for Source Client

. Collect the following data from your source cluster:

* Cluster name
* Cluster member addresses
* List of data structures to be migrated

. Navigate to the folder in which you extracted the DMT package
. Open the _migration_config/source/hazelcast.yaml_ file in your favorite editor
+
NOTE: The _hazelcast.yaml_ file is a Hazelcast client configuration file, which can include any supported configuration.
+
. Update the `cluster-name` field to match the name of your source cluster
. Update the `cluster-members` field to match the addresses of the cluster members
. Save the file

. Navigate to the folder in which you extracted the DMT package
. Open the _migration_config/data/imap_names.txt_ and/or the _migration_config/data/replicated_map_names.txt_ file in your favorite editor
. Update the file content to match the names of your maps. To select multiple data structures using a single entry, you can use wildcards. For further information on using wildcards, see the xref:configuration:using-wildcards.adoc[Using Wildcards] topic.
+
NOTE: If you have multiple data structures, use a new line for each map name.

. Save the file

=== Configuration for Target Client

. Collect the following data from your target cluster

* Cluster name
* Connection data (IP address or cloud configuration)
* If required, SSL keystore and truststore information

. Navigate to the folder in which you extracted the DMT package
. Open the _migration_config/target/hazelcast-client.yaml_ file in your favorite editor
+
NOTE: The _hazelcast-client.yaml_ file is a Hazelcast client configuration file, which can include any supported configuration.
+
. Update the `cluster-name` field to match the name of your source cluster
. Update the `network` section as follows:
+
* For an on-premise target cluster, update the `cluster-members` field to match the addresses of the cluster members
* For a cloud target cluster, including a {hazelcast-cloud} cluster, update the network information. For a public cloud cluster, refer to the documentation for the cloud provider for the required network details. For {hazelcast-cloud}, you must update the network section as follows:
+
----
hazelcast-client:
  :
  network:
    hazelcast-cloud:
      enabled: true
      discovery-token: <token>
----

. If required, add the `ssl` information. The format is as follows:
+
----
hazelcast-client:
  :
  network:
  :
    ssl:
      enabled: true
      properties:
        keyStore: client.keystore
        keyStorePassword: abc123
        trustStore: client.truststore
        trustStorePassword: abc123
----

. Save the file

NOTE: For further information on the `ssl` properties and their values, refer to the https://docs.hazelcast.com/cloud/connect-to-cluster#advanced[Using Advanced Setup^] section in the Hazelcast {hazelcast-cloud} documentation.

For example, the file content for a cloud target cluster will look similar to the following:

----
hazelcast-client:
  cluster-name: xyz
  network:
    hazelcast-cloud:
      enabled: true
      discovery-token: tokentoken
    ssl:
      enabled: true
      properties:
        keyStore: client.keystore
        keyStorePassword: abc123
        trustStore: client.truststore
        trustStorePassword: abc123
----


== Migrate your Data with the DMT

=== Caveats

When using the DMT, bear the following in mind:

* You can run only one migration at a time
* The target cluster must be on 5.3.x Enterprise Edition or the latest {hazelcast-cloud} release

NOTE: {hazelcast-cloud} Trial and {hazelcast-cloud} Standard have a limit of 14GB of primary data. If you require more, you must use {hazelcast-cloud} Dedicated. For further information on the available {hazelcast-cloud} editions, refer to the https://docs.hazelcast.com/cloud/overview[Hazelcast {hazelcast-cloud}^] documentation.

* You must specify at least one data structure name in the migration configuration file
* All data structures specified in the migration configuration must exist in the source cluster
* Any populated data structures that already exist on the target cluster are not migrated; however, if the existing data structure is empty, it is migrated
* Any empty data structures are not migrated

=== Step 1: Start the Migration Cluster

To start the migration cluster, complete the following steps:

. Open a terminal
. Navigate to the folder in which you extracted the DMT package
. Enter the following command:
+
[source,shell]
----
HZ_NETWORK_PORT_PORT=5702 HZ_CLUSTERNAME=migration ./bin/hz start 
----

If the specified port is available, the cluster starts on that port. Otherwise, Hazelcast tries to find a free port as described in the xref:clusters:network-configuration.adoc#port[Port] section of the Networking topic. You can confirm the port used by the cluster in the logs displayed in your terminal.

You can find the _migration.yaml_ file in the root folder of the DMT download package. If your logs show that the cluster starts on a different port to that specified in this file, you must update the `address` field to match the port number used.

DMT uses this configuration file to connect to the migration cluster when running the migration.

NOTE: The _migration.yaml_ file uses the same configuration options as the Hazelcast CLC. For further information on the options, refer to the https://docs.hazelcast.com/clc/latest/clc-config[Hazelcast CLC documentation^].


=== Step 2: Disconnect all Client Applications

Disconnect all client applications from the source cluster. 

[NOTE]
To further guarantee a consistent migration, Hazelcast recommends that the source cluster is put in a `PASSIVE` state before you start the migration. This is because the DMT cannot guarrantee that any data changed during migration will be migrated. For information on changing the state, see xref:maintain-cluster:cluster-member-states.adoc#changing-a-clusters-state[Changing a Cluster's State]. 


=== Step 3: Run the Migration Tool

. From your terminal window, navigate to the foloer containing the extracted DMT package. 
. Enter the following command:
+
[source,shell]
----
./bin/dmt_[platform]_[arch] --config migration.yaml start migration_config --yes --log.path migration.log
----

[NOTE]
====
. `--log.path migration.log` specifies that the migration logs are saved to the _migration.log_ file on completion of the migration. For further information on viewing the migration details, see the xref:migrate:data-migration-tool.adoc#view-result[View Migration Results]
. The DMT will attempt to connect to the migration cluster indefinitely. This means that it can appear to hang if unable to connect. To avoid this, you can set a timeout for the connection attempt using the `--timeout` flag.  For further information on the `--timeout` flag, refer to the https://docs.hazelcast.com/clc/5.3.5/configuration#clc-configuration-with-command-line-parameters[CLC Configuration with Command-line Parameters^] section of the Hazelcast CLC documentation. 
. On MacOS, you might need to allow the `dmt*` binary to run. If the command is rejected, go to the *Privacy & Security* settings on your device and update them to allow the binary. After updating the settings, retry the command, and select *Open* when prompted
====

You can use the DMT `status` command to track the migration. For further information on the available DMT commands, see the xref:migrate:dmt-command-reference.adoc[DMT Command Reference].

=== Step 4: Verify the Migrated Data

You can verify the size of the map in the target cluster in the following ways:

* Use the Hazelcast Management Center
+
To use the Hazelcast Management Center, you can use either of the following methods:
+
** Check the target map size, as described in the https://docs.hazelcast.com/management-center/5.3/data-structures/map[Maps] section of the Hazelcast Management Center documentation
** Check the map entries, as described in the https://docs.hazelcast.com/management-center/5.3/data-structures/map#map-browser[Exploring Map Entries] section of the Hazelcast Management Center documentation

* Use Hazelcast CLC 
+
To use Hazelcast CLC to verify the migrated map size, enter the following command in your terminal:
+
[source,shell]
----
clc -c target.yaml map size --name my-map
----
+
The output is similar to the following
+
[source,shell]
----
1000
OK
----

You can also check a random value from the data we populated in the xref:migrate:data-migration-tool.adoc#add-data-to-cluster[Add Data to Cluster] section above using the following command:

[source,shell]
----
clc -c target.yaml map get key-42 --name my-map
----

The output is similar to the following:

[source,shell]
----
value-42
OK
----

[view-result]

The DMT creates the following additional information:

* Migration report
+
This is written to the _migration$$_$$report$$_$$[migration_id].txt_ file in the directory used when running the `dmt` command.

* DMT log file
+
This is the file specified in the `--log.path` flag of the `start` command.
+
If the flag is not used, the file is saved to the location set in the `CLC_HOME` environment variable. If this environment variable is not set, the default location is the _~/.hazelcast_ folder.
+
NOTE: Logging uses the same environment variables as Hazelcast CLC. For further information on environment variables, refer to the https://docs.hazelcast.com/clc/latest/environment-variables[Environment Variables^] section of the Hazelcast CLC documentation.
+
The DMT log file includes migration member logs and other DMT logs.
+
The migration member logs are in the format `[(migration_id)_(member uuid)] (member log)`.

* `__datamigration_results` IMap
+
This is created on the target cluster.
+
The keys are UUID4 string format migration IDs, and the values are `HazelcastJsonValue` serialization interfaces that correspond to migration statuses. A migration status represents the details of the completed migration, and can be provided when contacting Hazelcast Support to help us in our investigations into your issue.
+
The migration report is also included as a field.

=== Step 5: Configure your Client Applications

Refer to the Hazelcast client library documentation for the client language you are using.

* xref:clients/java.adoc#client-api[]
* xref:clients/dotnet.adoc[]
* xref:clients/cplusplus.adoc[]
* xref:clients/python.adoc[]
* xref:clients/go.adoc[]

=== Step 6: Connect your Clients to the Target Cluster

Follow the startup procedures for your client applications.






